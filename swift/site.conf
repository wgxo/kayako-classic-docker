# Default server configuration
#
server {
	listen 80 default_server;

	root /var/www/html;

	index index.php index.html index.htm index.nginx-debian.html;

	server_name _;

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	location ~ /\.ht {
	  deny all;
	}

	location ~ /swift\/? {
		root /var/www;
		try_files $uri /swift/index.php?$query_string;
		rewrite ^/([^\/]+)\/(.*)$ /$1/index.php?$2;
		location ~ \.php$ {                                    
		  include snippets/fastcgi-php.conf;             
		  fastcgi_pass unix:/var/run/php/php5.6-fpm.sock;
			fastcgi_read_timeout 180;
		}

    location ~ ^/swift/(setup|admin|agent|api|cron|desktop|intranet|oauth|visitor|winapp|staffapi|__data/cache|__data/files|service)(.*)$ {
      try_files $uri $uri /swift/$1/index.php?$2&$query_string;
    }

		# Rewrite rule for logo and favicon
		location ~ ^/(logo|favicon)\.(ico|jpg|png) {
			rewrite /swift/(logo|favicon)\.(ico|jpg|png)(.*) /swift/api/v1/$1/render.json$3;
		}

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2|ttf|otf)$ {
      try_files $uri =404;
      expires max;
      log_not_found off;
    }
	}

  location ~ ^(/(pub)/.*)$ {
    try_files $uri $uri /magento/$1;
  }

  location ~ ^/magento/setup/$ {
		 return 301 /magento/setup/index.php;
	}

  location ~ ^/magento$ {
		 return 301 /magento/index.php;
	}

  location /magento/ {
	  root /var/www;
    try_files $uri $uri /magento/index.php?$query_string;
#		rewrite ^/([^\/]+)(\/(.*))?$ /$1/index.php?$2;
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2|ttf|otf)$ {
      try_files $uri =404;
      expires max;
      log_not_found off;
    }
	  location ~ \.php$ {                                    
	    include snippets/fastcgi-php.conf;             
	    fastcgi_pass unix:/var/run/php/php5.6-fpm.sock;
	  }                                                      
	}

#  location ~ ^(/(media|installation|template)/.*)$ {
#    try_files $uri $uri /joomla/$1;
#  }

	location ~ /joomla\/? {
	  root /var/www;
    try_files $uri /joomla/index.php?$query_string;
		rewrite ^/([^\/]+)(\/(.*))?$ /$1/index.php?$2;
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2|ttf|otf)$ {
      try_files $uri =404;
      expires max;
      log_not_found off;
    }
	  location ~ \.php$ {                                    
	    include snippets/fastcgi-php.conf;             
	    fastcgi_pass unix:/var/run/php/php5.6-fpm.sock;
	  }                                                      
    location ~ ^/joomla/(administrator)(.*)$ {
      try_files $uri $uri /joomla/$1/index.php?$2;
    }
	}

  location ~ ^/drupal$ {
		 return 301 /drupal/;
	}
	
	location /drupal/ {
		root /var/www;

    try_files $uri /drupal/index.php?$query_string; # For Drupal >= 7
		rewrite ^/([^\/]+)\/(.*)$ /$1/index.php?$2;

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
      try_files $uri =404;
      expires max;
      log_not_found off;
    }
		
	  location ~ \.php$ {                                    
	    include snippets/fastcgi-php.conf;             
	    fastcgi_pass unix:/var/run/php/php5.6-fpm.sock;
	  }

    location ~ ^/sites/.*/files/styles/ { # For Drupal >= 7
       try_files $uri @rewrite;
    }

    # Handle private files through Drupal. Private file's path can come
    # with a language prefix.
    location ~ ^(/[a-z\-]+)?/system/files/ { # For Drupal >= 7
       try_files $uri /index.php?$query_string;
    }
	}

	location /wordpress/ {
	  root /var/www;
    try_files $uri /wordpress/index.php?$query_string;
		rewrite ^/([^\/]+)\/(.*)$ /$1/index.php?$2;
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2|ttf|otf)$ {
      try_files $uri =404;
      expires max;
      log_not_found off;
    }
	  location ~ \.php$ {                                    
	    include snippets/fastcgi-php.conf;             
	    fastcgi_pass unix:/var/run/php/php5.6-fpm.sock;
	  }                                                      
	}


	location / {
	  add_header 'X-Frame-Options' 'SAMEORIGIN';
	  try_files $uri $uri/ =404;
	}

}
